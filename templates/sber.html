<!DOCTYPE html>
<html>
<head>
    <title>–ê–ú–ò–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–±–µ—Ä-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* –°–ø–∏–Ω–Ω–µ—Ä */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #spinner {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        #spinner div {
            width: 50px; height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä */
        .multiselect-container { position: relative; }
        .multiselect-display {
            border: 1px solid #ccc; padding: 8px 12px;
            border-radius: 4px; background: white; cursor: pointer;
            min-height: 40px; display: flex; align-items: center;
            flex-wrap: wrap; gap: 5px;
        }
        .multiselect-dropdown {
            display: none; position: absolute;
            top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #ccc;
            border-top: none; border-radius: 0 0 4px 4px;
            max-height: 200px; overflow-y: auto; z-index: 1000;
        }
        .multiselect-option {
            padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;
        }
        .multiselect-option:hover { background: #f5f5f5; }
        .multiselect-option.selected { background: #e3f2fd; }
        .selected-tag {
            background: #3498db; color: white;
            padding: 2px 8px; border-radius: 12px;
            font-size: 12px; display: inline-flex; align-items: center;
        }
        .selected-tag .remove {
            margin-left: 5px; cursor: pointer; font-weight: bold;
        }
        .placeholder { color: #999; }
        .multiselect-open .multiselect-dropdown { display: block; }
        .multiselect-open .multiselect-display { border-radius: 4px 4px 0 0; }

        /* –û—Å–Ω–æ–≤–Ω–æ–π layout */
        .main-container {
            display: flex; gap: 20px; max-width: 1200px; margin: 0 auto;
        }
        .form-container { flex: 1; }
        .containerDOWNLOAD {
            flex: 0 0 350px;
            background: #f8f9fa; padding: 20px;
            border-radius: 8px; border: 1px solid #ddd;
        }
        .containerDOWNLOAD h2 {
            margin-top: 0; color: #333;
            border-bottom: 2px solid #3498db; padding-bottom: 10px;
        }

        /* –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ */
        #advanced-settings {
            display: none; margin-top: 20px; margin-bottom: 20px;
            padding: 15px; border: 1px solid #ccc; border-radius: 5px;
        }

        /* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        .help-text {
            margin-top: 5px; font-size: 12px; color: #666;
            background-color: #f9f9f9; padding: 8px;
            border-radius: 4px; border-left: 3px solid #007cba;
            user-select: text; line-height: 1.4;
        }
        .checkbox-inline {
            display: flex; align-items: center; gap: 8px;
        }
        .help-icon {
            font-weight: bold; cursor: help;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            position: fixed; z-index: 10000; left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; border-radius: 8px;
            width: 90%; max-width: 500px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .modal-header {
            display: flex; justify-content: space-between;
            align-items: center; padding: 20px;
            border-bottom: 1px solid #eee;
        }
        .close {
            font-size: 24px; font-weight: bold;
            cursor: pointer; color: #999;
        }
        .close:hover { color: #333; }
        .modal-body { padding: 20px; }
        .file-status {
            font-size: 12px; margin-top: 5px; min-height: 15px;
        }
        .file-status.success { color: #27ae60; }
        .file-status.error { color: #e74c3c; }
        .modal-actions {
            display: flex; gap: 20px; justify-content: flex-end;
            margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;
        }
        .btn {
            padding: 10px 20px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn-secondary {
            background: #95a5a6; color: white;
        }
        .btn-secondary:hover { background: #7f8c8d; }
        .btn:disabled {
            background: #bdc3c7; cursor: not-allowed; color: white;
        }
        #submitUpload {
            background: #27ae60; color: white;
        }
        #submitUpload:not(:disabled):hover {
            background: #219a52;
        }
        input[type="file"], input[type="text"] {
            width: 100%; padding: 8px; border: 1px solid #ddd;
            border-radius: 4px; margin-top: 5px; box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- –§–æ—Ä–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
        <div class="container">
            <div class="signature">
                <img src="/static/logo.png" alt="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å—å" style="margin-bottom: 20px; margin-left: 40px;">
            </div>
            <form action="/sber/generate" method="post">
                <div class="form-group">
                    <label for="commonName"  title="–ò–º—è">Common Name:</label>
                    <input type="text" id="commonName" name="commonName" required>
                </div>
                <div class="form-group">
                    <label for="organization" title="–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è">Organization:</label>
                    <input type="text" id="organization" name="organization" value="Amicon">
                    
                </div>
                <div class="form-group">
                    <label for="organizationUnit" title="–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ">Organization Unit:</label>
                    <input type="text" id="organizationUnit" name="organizationUnit" value="Test">
                </div>
                <div class="form-group">
                    <label for="organizationUnit" title="–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ">Organization Unit2:</label>
                    <input type="text" id="organizationUnit2" name="organizationUnit2" value="Test">
                </div>
                <div class="form-group">
                    <label for="organizationUnit" title="–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ">Organization Unit2:</label>
                    <input type="text" id="organizationUnit3" name="organizationUnit3" value="Test">
                </div>
                <div class="form-group">
                    <label for="organizationUnit" title="–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ">Organization Unit4:</label>
                    <input type="text" id="organizationUnit4" name="organizationUnit4" value="Test">
                </div>

                <div class="form-group">
                    <label for="Domain Component" title="–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –î–æ–º–µ–Ω–∞">Domain Component:</label>
                    <input type="text" id="domainComponent" name="domainComponent" value="Test">
                </div>
                <div class="form-group">
                    <label for="Domain Component" title="–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –î–æ–º–µ–Ω–∞">Domain Component2:</label>
                    <input type="text" id="domainComponent2" name="domainComponent2" value="Test">
                </div>
                <div class="form-group">
                    <label for="Domain Component" title="–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –î–æ–º–µ–Ω–∞">Domain Component3:</label>
                    <input type="text" id="domainComponent3" name="domainComponent3" value="Test">
                </div>
                
                <div class="form-group">
                    <label for="country" title="–°—Ç—Ä–∞–Ω–∞">Country:</label>
                    <input type="text" id="country" name="country" value="RU" maxlength="2">
                </div>
                <div class="form-group">
                    <label for="locality" title="–†–µ–≥–∏–æ–Ω">Locality:</label>
                    <input type="text" id="locality" name="locality" value="Moscow">
                </div>
                <div class="form-group">
                    <label for="province" title="–ì–æ—Ä–æ–¥">Province:</label>
                    <input type="text" id="province" name="province" value="MSK">
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="text" id="email" name="email" value="info@amicon.ru">
                </div>
                <div class="form-group">
                    <label for="liveTime">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</label>
                    <select id="liveTime" name="liveTime">
                        <option value="1year">–°—Ä–æ–∫ –∂–∏–∑–Ω–∏ 1 –≥–æ–¥</option>
                        <option value="1day">–°—Ä–æ–∫ –∂–∏–∑–Ω–∏ 1 –¥–µ–Ω—å</option>
                        <option value="future1m">–°—Ä–æ–∫ –∂–∏–∑–Ω–∏ –Ω–∞—Å—Ç—É–ø–∏—Ç —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü</option>
                        <option value="future1d">–°—Ä–æ–∫ –∂–∏–∑–Ω–∏ –Ω–∞—Å—Ç—É–ø–∏—Ç –∑–∞–≤—Ç—Ä–∞</option>
                        <option value="future1h">–°—Ä–æ–∫ –∂–∏–∑–Ω–∏ –Ω–∞—Å—Ç—É–ø–∏—Ç —á–µ—Ä–µ–∑ —á–∞—Å</option>
                        <option value="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox-inline">
                        <input type="checkbox" id="utcCheckbox" name="utc" value="1" checked>
                        <label for="utcCheckbox">–í—Ä–µ–º—è –ø–æ UTC (GMT)</label>
                        <span class="help-icon" title="–ï—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, —Ç–æ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –≤—Ä–µ–º—è –ø–æ –ú–°–ö">?</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="keyType">–¢–∏–ø –∫–ª—é—á–∞:</label>
                    <select id="keyType" name="keyType">
                        <option value="rsa2048">RSA 2048</option>
                        <option value="rsa4096">RSA 4096</option>
                        <option value="GOST2012256">GOST2012(256)</option>
                        <option value="GOST2012512">GOST2012(512)</option>
                    </select>
                    <small class="form-text text-muted" style="color: #e74c3c; text-align: center; font-weight: bold; font-size: 0.875em; margin-top: 4px; display: block;">
                        ‚ö†Ô∏è –í —Å–≤—è–∑–∏ —Å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º–∏ openssl gost engine - —Ç–∏–ø –∫–ª—é—á–∞ RSA –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å—å –ì–û–°–¢–æ–≤—ã–º –£–¶, –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç.
                    </small>
                </div>
                <div class="form-group">
                    <label>–¢–∏–ø —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:</label>
                    <div class="multiselect-container" id="certTypeMultiselect">
                        <div class="multiselect-display" id="certTypeDisplay">
                            <span class="placeholder">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤...</span>
                        </div>
                        <div class="multiselect-dropdown" id="certTypeDropdown">
                            <div class="multiselect-option" data-value="client">–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π</div>
                            <div class="multiselect-option" data-value="server">–°–µ—Ä–≤–µ—Ä–Ω—ã–π</div>
                            <div class="multiselect-option" data-value="email">Email</div>
                            <div class="multiselect-option" data-value="empty">–ü—É—Å—Ç–æ–µ</div>
                        </div>
                        <input type="hidden" id="certType" name="certType" value="">
                    </div>
                </div>
                <div class="form-group">
                    <label for="caName">–£–¥–æ—Å—Ç–æ–≤–µ—Ä—è—é—â–∏–π —Ü–µ–Ω—Ç—Ä:</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <select id="caName" name="caName">
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                        </select>
                        <button type="button" id="refreshCA" title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –£–¶" style="background-color: #6d39e7;">üîÑ</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤</label>
                    <input type="number" id="count" name="count" value="1" min="1" max="100">
                </div>
                <div class="form-group">
                    <button type="button" id="toggleAdvanced">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                </div>
                <div id="advanced-settings">
                    <h3>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
                    <div class="form-group">
                        <label for="crlDistributionPoints" title="–¢–æ—á–∫–∞ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –æ—Ç–∑—ã–≤–∞">CRL Distribution Points:</label>
                        <input type="text" id="crlDistributionPoints" name="crlDistributionPoints" value=" ">
                        <div class="help-text">–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ - –≤–≤–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –ë–ï–ó –ü–†–û–ë–ï–õ–û–í</div>
                    </div>
                    <div class="form-group">
                        <label for="authorityInfoAccess" title="–î–æ—Å—Ç—É–ø –∫ —Å–≤–µ–¥–µ–Ω–∏—è–º —Ü–µ–Ω—Ç—Ä–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏">Authority Info Access:</label>
                        <input type="text" id="authorityInfoAccess" name="authorityInfoAccess" value=" ">
                        <div class="help-text">–ü—Ä–∏–º–µ—Ä: OCSP;http://192.168.28.4,CAIssuers;http://192.168.28.2<br>–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ - –≤–≤–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –ë–ï–ó –ü–†–û–ë–ï–õ–û–í</div>
                    </div>
                    <div class="form-group">
                        <label for="serial">Serial Number:</label>
                        <input type="text" id="serial" name="serial" inputmode="numeric" pattern="[0-9]*" value="0"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                        <div class="help-text">–ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å 0 ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∞–º</div>
                    </div>
                    <div class="form-group">
                        <label for="upn">User Principal Name:</label>
                        <input type="text" id="upn" name="upn" value=" ">
                        <div class="help-text">–§–æ—Ä–º–∞—Ç: user@domain.com –∏–ª–∏ user@domain.local</div>
                    </div>
                </div>
                <button type="submit">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</button>
            </form>
            {{if .Error}}
            <div class="error">{{.Error}}</div>
            {{end}}
        </div>

        <!-- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –£–¶ -->
        <div class="containerDOWNLOAD">
                <h2>–°–∫–∞—á–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –£–¶</h2>

                <div class="form-group">
                    <label for="downloadCaName">–£–¥–æ—Å—Ç–æ–≤–µ—Ä—è—é—â–∏–π —Ü–µ–Ω—Ç—Ä:</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <select class="select" id="downloadCaName" name="caName">
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                        </select>
                        <button type="button" id="refreshDownloadCA" title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –£–¶" style="background-color: #6d39e7;width: 50px; margin-top: 20px;">üîÑ</button>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <form id="downloadForm" action="/download/cert" method="get" style="display: inline;">
                        <input type="hidden" id="downloadFormCaInput" name="caName">
                        <button type="submit" class="button" style="margin-bottom: 0;">–°–∫–∞—á–∞—Ç—å</button>
                    </form>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
                    <button type="button" id="openUploadModal" class="button" style="background: #6d39e7; margin-bottom: 0;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –£–¶</button>


                    
                </div>

                <div style="margin-top: 60px;"> 
                <h2>–°–æ–∑–¥–∞—Ç—å PKCS12 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (.pfx)</h2>

                <button type="button" id="createPfx" class="button" style="background: #6d39e7; margin-bottom: 0;">–°–æ–∑–¥–∞—Ç—å</button>
                </div>

                <div style="margin-top: 60px;">
                    <a href="/">
                        <button type="button" style="background-color: #6d39e7;">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –æ–±—ã—á–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä </button>
                    </a>
                </div>
              
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ –£–¶ -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –£–¥–æ—Å—Ç–æ–≤–µ—Ä—è—é—â–µ–≥–æ –¶–µ–Ω—Ç—Ä–∞</h3>
                <span class="close">√ó</span>
            </div>
            <div class="modal-body">
                <div id="uploadError" class="error-message" style="display: none;"></div>
                <form id="uploadCAForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="certFile">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (.cer/.crt):</label>
                        <input type="file" id="certFile" accept=".cer,.crt" required>
                        <div id="certFileStatus" class="file-status"></div>
                    </div>
                    <div class="form-group">
                        <label for="keyFile">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (.key):</label>
                        <input type="file" id="keyFile" accept=".key" required>
                        <div id="keyFileStatus" class="file-status"></div>
                    </div>
                    <div class="form-group">
                        <label for="caName">–ò–º—è –£–¶:</label>
                        <input type="text" id="caName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —É–¥–æ—Å—Ç–æ–≤–µ—Ä—è—é—â–µ–≥–æ —Ü–µ–Ω—Ç—Ä–∞" required>
                        <small class="form-text text-muted" style="color: #e74c3c; text-align: center; font-weight: bold; font-size: 0.875em; margin-top: 4px; display: block;">
                            ‚ö†Ô∏è –ò–º—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –£–¶ –¥–æ–ª–∂–Ω–æ –∏–º–µ—Ç—å –≤–∏–¥ <br>
                            [–ê–õ–ì–û–†–ò–¢–ú-–ù–ê–ó–í–ê–ù–ò–ï-–î–õ–ò–ù–ê–ö–õ–Æ–ß–ê]<br>
                            –ù–∞–ø—Ä–∏–º–µ—Ä "rsa-org1-2048".
                        </small>
                    </div>
                    <div class="modal-actions">
                        <button type="button" id="cancelUpload" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" id="submitUpload" class="btn" disabled>–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –°–æ–∑–¥–∞–Ω–∏–µ pfx-->
 
       <div id="createPfxModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–°–æ–∑–¥–∞—Ç—å PKCS#12 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (.pfx)</h3>
            <span class="close pfx-close">√ó</span>
        </div>
        <div class="modal-body">
            <div id="pfxError" class="error-message" style="display: none;"></div>
            <form id="createPfxForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="pfxCertFile">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (.cer / .crt):</label>
                    <input type="file" id="pfxCertFile" name="certFile" accept=".cer,.crt" required>
                </div>
                <div class="form-group">
                    <label for="pfxKeyFile">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (.key):</label>
                    <input type="file" id="pfxKeyFile" name="keyFile" accept=".key" required>
                </div>
                <div class="form-group">
                    <label for="keyTypePFX">–¢–∏–ø –∫–ª—é—á–∞:</label>
                    <select id="keyTypePFX" name="keyTypePFX">
                        <option value="RSA">RSA</option>
                        <option value="GOST">GOST</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pfxPassword">–ü–∞—Ä–æ–ª—å –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:</label>
                    <input type="password" id="pfxPassword" name="password" placeholder="–ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞" minlength="4" required>
                </div>
                <div class="modal-actions">
                    <button type="button" id="cancelPfx" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" id="submitPfx" class="btn">–°–æ–∑–¥–∞—Ç—å .pfx</button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- –°–ø–∏–Ω–Ω–µ—Ä -->
    <div id="spinner"><div></div></div>



<script>
// ========== –°–æ–∑–¥–∞–Ω–∏–µ PFX –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ==========
const pfxModal = document.getElementById('createPfxModal');
const openPfxBtn = document.getElementById('createPfx');
const pfxCloseBtns = document.querySelectorAll('.pfx-close, #cancelPfx');
const pfxForm = document.getElementById('createPfxForm');
const pfxCertInput = document.getElementById('pfxCertFile');
const pfxKeyInput = document.getElementById('pfxKeyFile');
const pfxPasswordInput = document.getElementById('pfxPassword');
const pfxKeyTypeSelect = document.getElementById('keyTypePFX'); // ‚Üê –¥–æ–±–∞–≤–ª–µ–Ω–æ
const pfxCertStatus = document.getElementById('pfxCertStatus');
const pfxKeyStatus = document.getElementById('pfxKeyStatus');
const pfxSubmitBtn = document.getElementById('submitPfx');
const pfxErrorEl = document.getElementById('pfxError');

function showPfxError(msg) {
    pfxErrorEl.textContent = msg;
    pfxErrorEl.style.display = 'block';
}
function hidePfxError() {
    pfxErrorEl.style.display = 'none';
}
function resetPfxForm() {
    pfxForm.reset();
    pfxCertStatus.textContent = pfxKeyStatus.textContent = '';
    pfxCertStatus.className = pfxKeyStatus.className = 'file-status';
    pfxSubmitBtn.disabled = true;
    hidePfxError();
}

function validatePfxForm() {
    const cert = pfxCertInput.files[0];
    const key = pfxKeyInput.files[0];
    const pwd = pfxPasswordInput.value.trim();

    hidePfxError();

    let certValid = false, keyValid = false, pwdValid = false;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
    if (cert) {
        const ext = cert.name.toLowerCase().split('.').pop();
        if (['cer', 'crt'].includes(ext)) {
            pfxCertStatus.className = 'file-status success';
            pfxCertStatus.textContent = '‚úì –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤—ã–±—Ä–∞–Ω';
            certValid = true;
        } else {
            pfxCertStatus.className = 'file-status error';
            pfxCertStatus.textContent = '‚ùå –¢–æ–ª—å–∫–æ .cer –∏–ª–∏ .crt';
        }
    } else {
        pfxCertStatus.textContent = '';
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞
    if (key) {
        const ext = key.name.toLowerCase().split('.').pop();
        if (ext === 'key') {
            pfxKeyStatus.className = 'file-status success';
            pfxKeyStatus.textContent = '‚úì –ö–ª—é—á –≤—ã–±—Ä–∞–Ω';
            keyValid = true;
        } else {
            pfxKeyStatus.className = 'file-status error';
            pfxKeyStatus.textContent = '‚ùå –¢–æ–ª—å–∫–æ .key';
        }
    } else {
        pfxKeyStatus.textContent = '';
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
    if (pwd.length >= 4) {
        pwdValid = true;
    }

    pfxSubmitBtn.disabled = !(certValid && keyValid && pwdValid);
}

// –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
[pfxCertInput, pfxKeyInput].forEach(el => el.addEventListener('change', validatePfxForm));
pfxPasswordInput.addEventListener('input', validatePfxForm);

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
openPfxBtn.addEventListener('click', () => {
    pfxModal.style.display = 'flex';
    resetPfxForm();
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
pfxCloseBtns.forEach(btn => btn.addEventListener('click', () => {
    pfxModal.style.display = 'none';
    resetPfxForm();
}));

window.addEventListener('click', e => {
    if (e.target === pfxModal) {
        pfxModal.style.display = 'none';
        resetPfxForm();
    }
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
pfxForm.addEventListener('submit', async e => {
    e.preventDefault();

    const formData = new FormData();
    formData.append('certFile', pfxCertInput.files[0]);
    formData.append('keyFile', pfxKeyInput.files[0]);
    formData.append('password', pfxPasswordInput.value.trim());
    formData.append('keyTypePFX', pfxKeyTypeSelect.value); // ‚Üê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!

    document.getElementById('spinner').style.display = 'flex';
    pfxSubmitBtn.disabled = true;
    pfxSubmitBtn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';
    hidePfxError();

    try {
        const res = await fetch('/pfx', {
            method: 'POST',
            body: formData
        });

        if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(errData.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ .pfx');
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'certificate.pfx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        pfxModal.style.display = 'none';
        resetPfxForm();
    } catch (err) {
        console.error('PFX error:', err);
        showPfxError('–û—à–∏–±–∫–∞: ' + err.message);
    } finally {
        document.getElementById('spinner').style.display = 'none';
        pfxSubmitBtn.disabled = false;
        pfxSubmitBtn.textContent = '–°–æ–∑–¥–∞—Ç—å .pfx';
    }
});
</script>

    <script>
        // ========== –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä —Ç–∏–ø–æ–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ ==========
        const multiselect = document.getElementById('certTypeMultiselect');
        const display = document.getElementById('certTypeDisplay');
        const dropdown = document.getElementById('certTypeDropdown');
        const hiddenInput = document.getElementById('certType');
        const options = dropdown.querySelectorAll('.multiselect-option');
        let selectedValues = [];

        display.addEventListener('click', e => {
            e.stopPropagation();
            multiselect.classList.toggle('multiselect-open');
        });

        options.forEach(option => {
            option.addEventListener('click', function () {
                const value = this.dataset.value;
                if (selectedValues.includes(value)) {
                    selectedValues = selectedValues.filter(v => v !== value);
                    this.classList.remove('selected');
                } else {
                    selectedValues.push(value);
                    this.classList.add('selected');
                }
                updateDisplay();
                updateHiddenInput();
            });
        });

        document.addEventListener('click', () => multiselect.classList.remove('multiselect-open'));

        function updateDisplay() {
            if (selectedValues.length === 0) {
                display.innerHTML = '<span class="placeholder">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤...</span>';
                return;
            }
            display.innerHTML = '';
            selectedValues.forEach(value => {
                const option = Array.from(options).find(opt => opt.dataset.value === value);
                const text = option ? option.textContent : value;
                const tag = document.createElement('span');
                tag.className = 'selected-tag';
                tag.innerHTML = `${text}<span class="remove" data-value="${value}">√ó</span>`;
                display.appendChild(tag);
            });
            display.querySelectorAll('.remove').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const val = btn.dataset.value;
                    selectedValues = selectedValues.filter(v => v !== val);
                    const opt = Array.from(options).find(o => o.dataset.value === val);
                    if (opt) opt.classList.remove('selected');
                    updateDisplay();
                    updateHiddenInput();
                });
            });
        }

        function updateHiddenInput() {
            hiddenInput.value = selectedValues.join(',');
        }

        // ========== –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ==========
        document.getElementById('toggleAdvanced').addEventListener('click', function () {
            const adv = document.getElementById('advanced-settings');
            if (adv.style.display === 'none') {
                adv.style.display = 'block';
                this.textContent = '–°–∫—Ä—ã—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏';
            } else {
                adv.style.display = 'none';
                this.textContent = '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏';
            }
        });

        // ========== –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –£–¶ ==========
        async function loadCAList(selectId) {
            const select = document.getElementById(selectId);
            const btn = selectId === 'caName' ? document.getElementById('refreshCA') : document.getElementById('refreshDownloadCA');
            select.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
            if (btn) {
                btn.disabled = true;
                btn.textContent = '‚è≥';
            }

            try {
                const res = await fetch('/update/ca');
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –£–¶');
                const data = await res.json();
                select.innerHTML = '';
                if (data.certificates?.length) {
                    data.certificates.forEach(ca => {
                        const opt = document.createElement('option');
                        opt.value = ca;
                        let label = ca;
                        if (ca.includes('-2048')) label = ca.replace('-2048', ' (RSA 2048)');
                        else if (ca.includes('-4096')) label = ca.replace('-4096', ' (RSA 4096)');
                        opt.textContent = label;
                        select.appendChild(opt);
                    });
                } else {
                    select.innerHTML = '<option value="">–ù–µ—Ç –£–¶</option>';
                }
            } catch (err) {
                console.error(err);
                select.innerHTML = '<option value="">–û—à–∏–±–∫–∞</option>';
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üîÑ';
                }
            }
        }

        // ========== –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∑–∫–∏ –£–¶ ==========
        const uploadModal = document.getElementById('uploadModal');
        const openUploadModalBtn = document.getElementById('openUploadModal');
        const closeModalBtn = document.querySelector('.close');
        const cancelUploadBtn = document.getElementById('cancelUpload');
        const certFileInput = document.getElementById('certFile');
        const keyFileInput = document.getElementById('keyFile');
        const caNameInput = document.getElementById('caName');
        const certFileStatus = document.getElementById('certFileStatus');
        const keyFileStatus = document.getElementById('keyFileStatus');
        const submitUploadBtn = document.getElementById('submitUpload');
        const uploadError = document.getElementById('uploadError');

        function showError(msg) {
            uploadError.textContent = msg;
            uploadError.style.display = 'block';
        }
        function hideError() {
            uploadError.style.display = 'none';
        }
        function resetForm() {
            document.getElementById('uploadCAForm').reset();
            certFileStatus.textContent = keyFileStatus.textContent = '';
            certFileStatus.className = keyFileStatus.className = 'file-status';
            submitUploadBtn.disabled = true;
            hideError();
        }
        function closeModal() {
            uploadModal.style.display = 'none';
            resetForm();
        }

        openUploadModalBtn.addEventListener('click', () => {
            uploadModal.style.display = 'flex';
            resetForm();
        });
        [closeModalBtn, cancelUploadBtn].forEach(el => el.addEventListener('click', closeModal));
        window.addEventListener('click', e => { if (e.target === uploadModal) closeModal(); });

        function validateFiles() {
            const cert = certFileInput.files[0];
            const key = keyFileInput.files[0];
            const name = caNameInput.value.trim();
            hideError();

            let certValid = false, keyValid = false;

            if (cert) {
                const ext = cert.name.toLowerCase().split('.').pop();
                if (['cer', 'crt'].includes(ext)) {
                    certFileStatus.className = 'file-status success';
                    certFileStatus.textContent = '‚úì –§–∞–π–ª —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –≤—ã–±—Ä–∞–Ω';
                    certValid = true;
                } else {
                    certFileStatus.className = 'file-status error';
                    certFileStatus.textContent = '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª .cer –∏–ª–∏ .crt';
                }
            } else certFileStatus.textContent = '';

            if (key) {
                const ext = key.name.toLowerCase().split('.').pop();
                if (ext === 'key') {
                    keyFileStatus.className = 'file-status success';
                    keyFileStatus.textContent = '‚úì –§–∞–π–ª –∫–ª—é—á–∞ –≤—ã–±—Ä–∞–Ω';
                    keyValid = true;
                } else {
                    keyFileStatus.className = 'file-status error';
                    keyFileStatus.textContent = '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª .key';
                }
            } else keyFileStatus.textContent = '';

            submitUploadBtn.disabled = !(certValid && keyValid && name);
        }

        [certFileInput, keyFileInput, caNameInput].forEach(el => el.addEventListener('change', validateFiles));
        caNameInput.addEventListener('input', validateFiles);

        document.getElementById('uploadCAForm').addEventListener('submit', async e => {
            e.preventDefault();
            const formData = new FormData(e.target);
            document.getElementById('spinner').style.display = 'flex';
            submitUploadBtn.disabled = true;
            submitUploadBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            hideError();

            try {
                const res = await fetch('/upload/ca', { method: 'POST', body: formData });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                if (data.success) {
                    uploadError.style.cssText = 'display:block;background:#e8f5e8;border:1px solid #c3e6c3;color:#155724;';
                    uploadError.textContent = '–£–¥–æ—Å—Ç–æ–≤–µ—Ä—è—é—â–∏–π —Ü–µ–Ω—Ç—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!';
                    setTimeout(() => {
                        closeModal();
                        loadCAList('caName');
                        loadCAList('downloadCaName');
                    }, 1500);
                } else throw new Error(data.error);
            } catch (err) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message);
            } finally {
                document.getElementById('spinner').style.display = 'none';
                submitUploadBtn.disabled = false;
                submitUploadBtn.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å';
            }
        });

        // ========== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º —Å–∫–∞—á–∏–≤–∞–Ω–∏—è ==========
        document.getElementById('downloadCaName').addEventListener('change', function () {
            document.getElementById('downloadFormCaInput').value = this.value;
        });

        // ========== –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ liveTime –¥–ª—è –ì–û–°–¢ ==========
        document.addEventListener('DOMContentLoaded', () => {
            const keyType = document.getElementById('keyType');
            const liveTime = document.getElementById('liveTime');
            const allOptions = Array.from(liveTime.querySelectorAll('option'));

            function updateLiveTime() {
                const isGost = ['GOST2012256', 'GOST2012512'].includes(keyType.value);
                liveTime.innerHTML = '';
                allOptions.forEach(opt => {
                    if (!isGost || ['1year', '1day', 'overdue'].includes(opt.value)) {
                        liveTime.appendChild(opt.cloneNode(true));
                    }
                });
                if (!Array.from(liveTime.options).some(o => o.value === liveTime.value)) {
                    liveTime.selectedIndex = 0;
                }
            }

            updateLiveTime();
            keyType.addEventListener('change', updateLiveTime);

            // –ó–∞–≥—Ä—É–∑–∫–∞ –£–¶
            loadCAList('caName');
            loadCAList('downloadCaName');

            // –ö–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            document.getElementById('refreshCA').addEventListener('click', () => loadCAList('caName'));
            document.getElementById('refreshDownloadCA').addEventListener('click', () => {
                loadCAList('downloadCaName');
                document.getElementById('downloadFormCaInput').value = '';
            });

            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            document.querySelector('form').addEventListener('submit', e => {
                if (selectedValues.length === 0) {
                    e.preventDefault();
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–∏–ø —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞');
                    return;
                }
                document.getElementById('spinner').style.display = 'flex';
                const btn = e.target.querySelector('button[type="submit"]');
                btn.disabled = true;
                btn.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
            });
        });
    </script>
</body>
</html>